DROP TABLE NTL_PRD_QMTMPTBLS.ECHAT_DETAIL;

CREATE MULTISET TABLE NTL_PRD_QMTMPTBLS.ECHAT_DETAIL AS (
SELECT
	CASE WHEN CAST((a.ECHAT_START_TS - INTERVAL '4' HOUR) AS DATE) <= 1160313 THEN
		CAST((a.ECHAT_START_TS - INTERVAL '5' HOUR) AS DATE) ELSE
		CAST((a.ECHAT_START_TS - INTERVAL '5' HOUR) AS DATE) END
		AS RPT_DATE
	,CASE WHEN a.ENG_SKILL_NM LIKE '%Device%' THEN 'Device'
        WHEN a.ENG_SKILL_NM LIKE '%Billing%' THEN 'Billing'
        WHEN a.ENG_SKILL_NM LIKE '%MVTrans%' THEN 'MVTrans'
        WHEN a.ENG_SKILL_NM LIKE '%Global%' THEN 'Global'
        ELSE 'OTHER' END AS SKILL_NM
	,SUBSTR(a.AGENT_ID, 0,11) AS EID
	,b.MTN
	,c.CUST_ID
	,c.CUST_LINE_SEQ_ID
	,a.ECHAT_SESSION_ID
	,MAX(CAST(CASE WHEN CAST((a.ECHAT_START_TS - INTERVAL '4' HOUR) AS DATE) <= 1160313 THEN
		(a.ECHAT_START_TS - INTERVAL '5' HOUR)  ELSE
		(a.ECHAT_START_TS - INTERVAL '5' HOUR) END AS TIMESTAMP))
		AS RPT_TIME

FROM VZWEB_PRD_ALLVM.ECHAT_ACTIVITY_V a

INNER JOIN VZWEB_PRD_ALLVM.ECHAT_SESSION_SUMMARY_V b
	ON a.ECHAT_SESSION_ID = b.ECHAT_SESSION_ID

LEFT JOIN NTL_PRD_ALLVM.MTN_XREF_DLY_HIST_V c
	ON b.MTN = c.MTN
	AND c.SOR_ID = 'V'
	AND c.MTN_STATUS_IND = 'A'
	AND CAST((a.ECHAT_START_TS - INTERVAL '5' HOUR) AS DATE) BETWEEN c.EFF_DT AND c.EXP_DT

WHERE CAST((a.ECHAT_START_TS - INTERVAL '5' HOUR) AS DATE) >= 1160308
	AND b.MTN IS NOT NULL
	AND a.AGENT_ID IS NOT NULL
	--AND b.CUST_TYPE_CD IS NOT NULL
	AND a.ECHAT_ABANDONED_IND = '0'
	AND COALESCE(NULLIF(SUBSTR(a.ENG_SKILL_NM, 0, POSITION('||' IN a.ENG_SKILL_NM)),''),a.ENG_SKILL_NM) IN 
														('Desktop-Billing','Phone-Billing','Tablet-Billing',
														'Desktop-MVTrans','Phone-MVTrans','Tablet-MVTrans',
														'Desktop-Global','Phone-Global','Tablet-Global',
														'Phone-Device','Tablet-Device','Desktop-Device')
GROUP BY
	1,2,3,4,5,6,7
)
WITH DATA
PRIMARY INDEX ( MTN, RPT_DATE)
INDEX(RPT_DATE)
;
CREATE TABLE NTL_PRD_QMTMPTBLS.CHAT_CUSTOMERS AS(

SELECT
	MTN
	,CUST_ID
	,CUST_LINE_SEQ_ID
	,MIN(RPT_DATE) AS EFF_DT
	,MAX(RPT_DATE + 31) AS EXP_DT

FROM NTL_PRD_QMTMPTBLS.ECHAT_DETAIL

GROUP BY 1,2,3)
WITH DATA
PRIMARY INDEX(MTN, CUST_ID, CUST_LINE_SEQ_ID, EFF_DT, EXP_DT)
;

INSERT INTO NTL_PRD_QMTMPTBLS.ECHAT_DETAIL
SELECT
	a.CALL_ANSWER_DT
	,'CALLS' 
	,NULL
	,a.MTN
	,a.CUST_ID
	,a.CUST_LINE_SEQ_ID
	,a.IVR_CALL_ID
	,CAST((CAST(a.CALL_ANSWER_DT AS FORMAT  'YYYY-MM-DD')  || ' ' || a.CALL_ANSWER_TM) AS TIMESTAMP) AS CALL_DT_TM
	
FROM NTL_PRD_ALLVM.ICM_SUMMARY_FACT_V a

INNER JOIN NTL_PRD_QMTMPTBLS.CHAT_CUSTOMERS b
	ON a.MTN = b.MTN
	AND a.CUST_ID = b.CUST_ID
	AND a.CUST_LINE_SEQ_ID = b.CUST_LINE_SEQ_ID
	AND a.CALL_ANSWER_DT BETWEEN b.EFF_DT AND b.EXP_DT
;
DROP TABLE NTL_PRD_QMTMPTBLS.CHAT_CUSTOMERS
;
CREATE MULTISET TABLE NTL_PRD_QMTMPTBLS.CHAT_CALL_DETAIL AS
(
SELECT
	a.RPT_DATE
	,a.SKILL_NM
	,a.EID
	,a.MTN
	,a.CUST_ID
	,a.CUST_LINE_SEQ_ID
	,a.RPT_TIME
	,ROW_NUMBER() OVER (PARTITION BY MTN, CUST_ID, CUST_LINE_SEQ_ID ORDER BY RPT_TIME, MTN) AS SQNCE

FROM NTL_PRD_QMTMPTBLS.ECHAT_DETAIL a
)
WITH DATA PRIMARY INDEX (MTN, CUST_ID, CUST_LINE_SEQ_ID, SQNCE)
;

SELECT
                a.RPT_DATE - EXTRACT(DAY FROM a.RPT_DATE) + 1 AS RPT_MONTH
                ,a.SKILL_NM
				,COUNT(*) AS TOTAL_CHATS
                ,SUM(CASE WHEN (a.RPT_DATE = b.RPT_DATE AND a.RPT_TIME < b.RPT_TIME) THEN 1 ELSE 0 END) AS SAME_DAY
                ,SUM(CASE WHEN (a.RPT_DATE = b.RPT_DATE AND (a.RPT_TIME + INTERVAL '2' HOUR) >= b.RPT_TIME) THEN 1 ELSE 0 END) AS TWO_HOUR
                ,SUM(CASE WHEN b.RPT_DATE BETWEEN (a.RPT_DATE +1) AND (a.RPT_DATE +2) THEN 1 ELSE 0 END) AS THREE_DAY
				,SUM(CASE WHEN b.RPT_DATE BETWEEN (a.RPT_DATE +1) AND (a.RPT_DATE +30) THEN 1 ELSE 0 END) AS THIRTY_DAY

FROM NTL_PRD_QMTMPTBLS.CHAT_CALL_DETAIL a

LEFT JOIN NTL_PRD_QMTMPTBLS.CHAT_CALL_DETAIL b
	ON a.CUST_ID = b.CUST_ID
	AND a.MTN = b.MTN
	AND COALESCE(a.EID,'None') <> COALESCE(b.EID,'None')
	AND a.CUST_LINE_SEQ_ID = b.CUST_LINE_SEQ_ID
	AND a.SQNCE + 1 = b.SQNCE
	AND b.SKILL_NM = 'CALLS'
/*	
LEFT JOIN NTL_PRD_ALLVM.EMPLOYEE_CONTRACTOR_HIST_V c
	ON a.EID = c.EID
	AND c.EMP_STATUS_IND = 'A'
	AND a.RPT_DATE BETWEEN c.EFF_DT AND c.EXP_DT*/

WHERE a.SKILL_NM IN('Billing','Device','Global','MVTrans')

GROUP BY 1,2
ORDER BY 1,2
;
DROP TABLE NTL_PRD_QMTMPTBLS.CHAT_CALL_DETAIL 
;   